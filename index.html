<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kurnik – Sterowanie</title>
  <style>
    body { font-family: sans-serif; margin: 10px; padding: 0; }
    h1 { text-align: center; }
    .section { border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
    .section h2 { margin-top: 0; }
    label { display: inline-block; width: 120px; }
    input[type="time"] { width: 120px; }
    button { margin: 5px; padding: 8px 12px; border-radius: 4px; border: none; background-color: #2c7; color: #fff; cursor: pointer; }
    button.red { background-color: #c33; }
    button.gray { background-color: #888; }
    .status-lamp { display: inline-block; width: 15px; height: 15px; border-radius: 50%; margin-right: 5px; background-color: #888; }
    .status-row { margin: 5px 0; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>Sterowanie Kurnikiem</h1>

  <div class="section">
    <h2>Harmonogram</h2>
    <div>
      <label for="timeOpen">Drzwi – otwórz:</label>
      <input id="timeOpen" type="time" /><br/>
      <label for="timeClose">Drzwi – zamknij:</label>
      <input id="timeClose" type="time" /><br/>
      <label for="timeLightOn">Światło – ON:</label>
      <input id="timeLightOn" type="time" /><br/>
      <label for="timeLightOff">Światło – OFF:</label>
      <input id="timeLightOff" type="time" /><br/><br/>
      <button id="btnSaveSchedule">Zapisz harmonogram</button>
      <span id="schedStatus" style="margin-left: 10px; color: green;"></span>
    </div>
  </div>

  <div class="section">
    <h2>Sterowanie ręczne</h2>
    <div class="status-row">
      <span class="status-lamp" id="lampLightState"></span>
      Stan światła:
      <button id="btnLightOn">Włącz</button>
      <button class="red" id="btnLightOff">Wyłącz</button>
    </div>
    <div class="status-row">
      <span class="status-lamp" id="lampDoorState"></span>
      Stan drzwi:
      <button id="btnDoorOpen">Otwórz</button>
      <button class="red" id="btnDoorClose">Zamknij</button>
      <button class="gray" id="btnDoorStop">STOP</button>
    </div>
    <div class="status-row">
      <span class="status-lamp" id="lampLimitOpen"></span> Krańcówka OTWARCIA 
      <span class="status-lamp" id="lampLimitClose" style="margin-left: 20px;"></span> Krańcówka ZAMKNIĘCIA
    </div>
  </div>

  <script>
    const host = window.location.hostname;
    const port = 9001;
    const clientId = 'web_' + Math.random().toString(16).substr(2, 8);
    const options = {
      keepalive: 60,
      clientId: clientId,
      protocolId: 'MQTT',
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 2000,
      connectTimeout: 4000,
    };
    const mqttClient = mqtt.connect(`ws://${host}:${port}`, options);

    mqttClient.on('connect', () => {
      console.log('Połączono z MQTT przez WebSocket');
      mqttClient.subscribe('kurnik/schedule/state');
      mqttClient.subscribe('kurnik/light/state');
      mqttClient.subscribe('kurnik/door/state');
      mqttClient.subscribe('kurnik/limit/open');
      mqttClient.subscribe('kurnik/limit/close');
    });
    mqttClient.on('error', (err) => { console.error('Błąd MQTT', err); });
    mqttClient.on('reconnect', () => { console.log('Próba ponownego połączenia MQTT...'); });

    function setLamp(id, on) {
      const lamp = document.getElementById(id);
      lamp.style.backgroundColor = on ? '#2c7' : '#888';
    }

    mqttClient.on('message', (topic, payload) => {
      const msg = payload.toString();
      if (topic === 'kurnik/schedule/state') {
        try {
          const sched = JSON.parse(msg);
          document.getElementById('timeOpen').value     = sched.timeOpen;
          document.getElementById('timeClose').value    = sched.timeClose;
          document.getElementById('timeLightOn').value  = sched.timeLightOn;
          document.getElementById('timeLightOff').value = sched.timeLightOff;
        } catch (e) {
          console.error('Błąd parsowania harmonogramu', e);
        }
      }
      else if (topic === 'kurnik/light/state') {
        setLamp('lampLightState', msg === 'ON');
      }
      else if (topic === 'kurnik/door/state') {
        setLamp('lampDoorState', msg === 'OPENING' || msg === 'CLOSING');
      }
      else if (topic === 'kurnik/limit/open') {
        setLamp('lampLimitOpen', msg === '1');
      }
      else if (topic === 'kurnik/limit/close') {
        setLamp('lampLimitClose', msg === '1');
      }
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        mqttClient.publish('kurnik/schedule/set', '{}');
      }, 500);
    });

    document.getElementById('btnSaveSchedule').addEventListener('click', () => {
      const tOpen     = document.getElementById('timeOpen').value;
      const tClose    = document.getElementById('timeClose').value;
      const tLightOn  = document.getElementById('timeLightOn').value;
      const tLightOff = document.getElementById('timeLightOff').value;
      if (tOpen && tClose && tLightOn && tLightOff) {
        const payload = JSON.stringify({
          timeOpen: tOpen,
          timeClose: tClose,
          timeLightOn: tLightOn,
          timeLightOff: tLightOff
        });
        mqttClient.publish('kurnik/schedule/set', payload);
        document.getElementById('schedStatus').textContent = "Wysłano...";
        setTimeout(() => { document.getElementById('schedStatus').textContent = ""; }, 2000);
      } else {
        alert("Uzupełnij wszystkie pola czasu.");
      }
    });

    document.getElementById('btnLightOn').addEventListener('click',  () => { mqttClient.publish('kurnik/light/cmd', 'ON'); });
    document.getElementById('btnLightOff').addEventListener('click', () => { mqttClient.publish('kurnik/light/cmd', 'OFF'); });
    document.getElementById('btnDoorOpen').addEventListener('click',  () => { mqttClient.publish('kurnik/door/cmd', 'OPEN'); });
    document.getElementById('btnDoorClose').addEventListener('click', () => { mqttClient.publish('kurnik/door/cmd', 'CLOSE'); });
    document.getElementById('btnDoorStop').addEventListener('click',  () => { mqttClient.publish('kurnik/door/cmd', 'STOP'); });
  </script>
</body>
</html>
