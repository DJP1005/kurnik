<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kurnik – Sterowanie</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; }
    h1 { text-align: center; }
    .time-display { text-align: center; font-size: 20px; margin: 10px 0; }
    .status-row, .schedule-row { margin: 10px 0; }
    .status-lamp { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; background: gray; }
    input[type="time"] { width: 120px; }
    button { margin: 5px 3px; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; }
    button.green { background: #2c7; color: white; }
    button.red { background: #c33; color: white; }
    button.gray { background: #888; color: white; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Sterowanie Kurnikiem</h1>
    <div class="time-display" id="espTime">--:--:--</div>

    <div class="status-row">
      <span class="status-lamp" id="lampLightState"></span> Światło
      <span class="status-lamp" id="lampDoorState" style="margin-left: 20px;"></span> Drzwi
    </div>
    <div class="status-row">
      <span class="status-lamp" id="lampLimitOpen"></span> Krańcówka OTWARCIA
      <span class="status-lamp" id="lampLimitClose" style="margin-left: 20px;"></span> Krańcówka ZAMKNIĘCIA
    </div>

    <div class="schedule-row">
      <label>Drzwi – otwórz:</label><input id="timeOpen" type="time"><br>
      <label>Drzwi – zamknij:</label><input id="timeClose" type="time"><br>
      <label>Światło – ON:</label><input id="timeLightOn" type="time"><br>
      <label>Światło – OFF:</label><input id="timeLightOff" type="time"><br>
      <button class="green" id="btnSaveSchedule">Zapisz harmonogram</button>
      <span id="schedStatus" style="color: green;"></span>
    </div>

    <div class="schedule-row">
      <button class="green" id="btnLightOn">Włącz światło</button>
      <button class="red" id="btnLightOff">Wyłącz światło</button><br>
      <button class="green" id="btnDoorOpen">Otwórz drzwi</button>
      <button class="red" id="btnDoorClose">Zamknij drzwi</button>
      <button class="gray" id="btnDoorStop">STOP</button>
    </div>
  </div>

  <script>
    const client = mqtt.connect("wss://42ceb2ec1aef4657b29ae73f374ca029.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "websocket",
      password: "Pawel1005",
      clientId: "web_" + Math.random().toString(16).substr(2, 8),
      keepalive: 60
    });

    let isEditing = false;

    document.querySelectorAll("input[type='time']").forEach(el => {
      el.addEventListener("input", () => {
        isEditing = true;
      });
    });

    client.on("connect", () => {
      client.subscribe("kurnik/time");
      client.subscribe("kurnik/light/state");
      client.subscribe("kurnik/door/state");
      client.subscribe("kurnik/limit/open");
      client.subscribe("kurnik/limit/close");
      client.subscribe("kurnik/schedule/state");
      client.publish("kurnik/schedule/request", "");
    });

    client.on("message", (topic, message) => {
      const msg = message.toString();
      if (topic === "kurnik/time") {
        document.getElementById("espTime").textContent = msg;
      } else if (topic === "kurnik/light/state") {
        document.getElementById("lampLightState").style.backgroundColor = msg === "ON" ? "green" : "gray";
      } else if (topic === "kurnik/door/state") {
        document.getElementById("lampDoorState").style.backgroundColor = msg !== "STOPPED" ? "green" : "gray";
      } else if (topic === "kurnik/limit/open") {
        document.getElementById("lampLimitOpen").style.backgroundColor = msg === "1" ? "green" : "gray";
      } else if (topic === "kurnik/limit/close") {
        document.getElementById("lampLimitClose").style.backgroundColor = msg === "1" ? "green" : "gray";
      } else if (topic === "kurnik/schedule/state" && !isEditing) {
        try {
          const sched = JSON.parse(msg);
          document.getElementById("timeOpen").value = sched.timeOpen;
          document.getElementById("timeClose").value = sched.timeClose;
          document.getElementById("timeLightOn").value = sched.timeLightOn;
          document.getElementById("timeLightOff").value = sched.timeLightOff;
        } catch (e) {
          console.error("Błąd JSON harmonogramu:", e);
        }
      }
    });

    document.getElementById("btnSaveSchedule").addEventListener("click", () => {
      const tOpen = document.getElementById("timeOpen").value;
      const tClose = document.getElementById("timeClose").value;
      const tLightOn = document.getElementById("timeLightOn").value;
      const tLightOff = document.getElementById("timeLightOff").value;
      if (tOpen && tClose && tLightOn && tLightOff) {
        const payload = JSON.stringify({
          timeOpen: tOpen,
          timeClose: tClose,
          timeLightOn: tLightOn,
          timeLightOff: tLightOff
        });
        client.publish("kurnik/schedule/set", payload);
        document.getElementById("schedStatus").textContent = "Wysłano...";
        setTimeout(() => {
          document.getElementById("schedStatus").textContent = "";
          isEditing = false;
        }, 2000);
      } else {
        alert("Uzupełnij wszystkie pola czasu.");
      }
    });

    document.getElementById("btnLightOn").addEventListener("click", () => {
      client.publish("kurnik/light/cmd", "ON");
    });
    document.getElementById("btnLightOff").addEventListener("click", () => {
      client.publish("kurnik/light/cmd", "OFF");
    });
    document.getElementById("btnDoorOpen").addEventListener("click", () => {
      client.publish("kurnik/door/cmd", "OPEN");
    });
    document.getElementById("btnDoorClose").addEventListener("click", () => {
      client.publish("kurnik/door/cmd", "CLOSE");
    });
    document.getElementById("btnDoorStop").addEventListener("click", () => {
      client.publish("kurnik/door/cmd", "STOP");
    });
  </script>
</body>
</html>
