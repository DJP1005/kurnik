<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kurnik – Sterowanie</title>
  <style>
    body { font-family: sans-serif; margin: 10px; padding: 0; background-color: #f4f4f4; }
    h1 { text-align: center; }
    .section { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin: 15px auto; max-width: 500px; }
    .section h2 { margin-top: 0; }
    label { display: inline-block; width: 130px; }
    input[type="time"] { width: 120px; }
    button { margin: 5px 3px; padding: 8px 14px; border-radius: 4px; border: none; cursor: pointer; }
    button.green { background-color: #2c7; color: #fff; }
    button.red { background-color: #c33; color: #fff; }
    button.gray { background-color: #888; color: #fff; }
    .status-lamp { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 5px; background-color: #888; }
    .status-row { margin: 6px 0; font-size: 15px; }
    .time-display { text-align: center; font-size: 20px; font-weight: bold; margin-top: 10px; }
    .schedule-readout { font-family: monospace; margin-top: 10px; background: #eee; padding: 10px; border-radius: 6px; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>Sterowanie Kurnikiem</h1>

  <div class="section">
    <h2>Zegar i statusy</h2>
    <div class="time-display" id="espTime">--:--:--</div>
    <div class="status-row"><span class="status-lamp" id="lampLightState"></span> Stan światła</div>
    <div class="status-row"><span class="status-lamp" id="lampDoorState"></span> Stan drzwi</div>
    <div class="status-row">
      <span class="status-lamp" id="lampLimitOpen"></span> Krańcówka OTWARCIA
      <span class="status-lamp" id="lampLimitClose" style="margin-left: 20px;"></span> Krańcówka ZAMKNIĘCIA
    </div>
    <div class="schedule-readout" id="schedDisplay">
      Otwórz: --:--<br>
      Zamknij: --:--<br>
      Światło ON: --:--<br>
      Światło OFF: --:--
    </div>
  </div>

  <div class="section">
    <h2>Harmonogram</h2>
    <label for="timeOpen">Drzwi – otwórz:</label><input id="timeOpen" type="time"><br>
    <label for="timeClose">Drzwi – zamknij:</label><input id="timeClose" type="time"><br>
    <label for="timeLightOn">Światło – ON:</label><input id="timeLightOn" type="time"><br>
    <label for="timeLightOff">Światło – OFF:</label><input id="timeLightOff" type="time"><br><br>
    <button class="green" id="btnSaveSchedule">Zapisz harmonogram</button>
    <span id="schedStatus" style="margin-left: 10px; color: green;"></span>
  </div>

  <div class="section">
    <h2>Sterowanie ręczne</h2>
    <button class="green" id="btnLightOn">Włącz światło</button>
    <button class="red" id="btnLightOff">Wyłącz światło</button><br>
    <button class="green" id="btnDoorOpen">Otwórz drzwi</button>
    <button class="red" id="btnDoorClose">Zamknij drzwi</button>
    <button class="gray" id="btnDoorStop">STOP</button>
  </div>

  <script>
    const client = mqtt.connect("wss://42ceb2ec1aef4657b29ae73f374ca029.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "websocket",
      password: "Pawel1005",
      clientId: "web_" + Math.random().toString(16).substr(2, 8),
      keepalive: 60
    });

    let isEditing = false;

    document.querySelectorAll("input[type='time']").forEach(el => {
      el.addEventListener("input", () => {
        isEditing = true;
      });
    });

    client.on("connect", () => {
      client.subscribe("kurnik/time");
      client.subscribe("kurnik/light/state");
      client.subscribe("kurnik/door/state");
      client.subscribe("kurnik/limit/open");
      client.subscribe("kurnik/limit/close");
      client.subscribe("kurnik/schedule/state");
    });

    client.on("message", (topic, message) => {
      const msg = message.toString();
      if (topic === "kurnik/time") {
        document.getElementById("espTime").textContent = msg;
      } else if (topic === "kurnik/light/state") {
        document.getElementById("lampLightState").style.backgroundColor = msg === "ON" ? "#2c7" : "#888";
      } else if (topic === "kurnik/door/state") {
        const moving = (msg === "OPENING" || msg === "CLOSING");
        document.getElementById("lampDoorState").style.backgroundColor = moving ? "#2c7" : "#888";
      } else if (topic === "kurnik/limit/open") {
        document.getElementById("lampLimitOpen").style.backgroundColor = msg === "1" ? "#2c7" : "#888";
      } else if (topic === "kurnik/limit/close") {
        document.getElementById("lampLimitClose").style.backgroundColor = msg === "1" ? "#2c7" : "#888";
      } else if (topic === "kurnik/schedule/state" && !isEditing) {
        try {
          const sched = JSON.parse(msg);
          document.getElementById("timeOpen").value = sched.timeOpen;
          document.getElementById("timeClose").value = sched.timeClose;
          document.getElementById("timeLightOn").value = sched.timeLightOn;
          document.getElementById("timeLightOff").value = sched.timeLightOff;
          document.getElementById("schedDisplay").innerHTML =
            `Otwórz: ${sched.timeOpen}<br>Zamknij: ${sched.timeClose}<br>Światło ON: ${sched.timeLightOn}<br>Światło OFF: ${sched.timeLightOff}`;
        } catch (e) {
          console.error("Nieprawidłowy JSON harmonogramu:", e);
        }
      }
    });

    window.addEventListener("load", () => {
      setTimeout(() => {
        client.publish("kurnik/schedule/set", "{}");
      }, 500);
    });

    document.getElementById("btnSaveSchedule").addEventListener("click", () => {
      const tOpen = document.getElementById("timeOpen").value;
      const tClose = document.getElementById("timeClose").value;
      const tLightOn = document.getElementById("timeLightOn").value;
      const tLightOff = document.getElementById("timeLightOff").value;

      if (tOpen && tClose && tLightOn && tLightOff) {
        const payload = JSON.stringify({
          timeOpen: tOpen,
          timeClose: tClose,
          timeLightOn: tLightOn,
          timeLightOff: tLightOff
        });
        client.publish("kurnik/schedule/set", payload);
        document.getElementById("schedStatus").textContent = "Wysłano...";
        setTimeout(() => { document.getElementById("schedStatus").textContent = ""; }, 2000);
        isEditing = false;
      } else {
        alert("Uzupełnij wszystkie pola czasu.");
      }
    });

    document.getElementById("btnLightOn").addEventListener("click", () => {
      client.publish("kurnik/light/cmd", "ON");
    });
    document.getElementById("btnLightOff").addEventListener("click", () => {
      client.publish("kurnik/light/cmd", "OFF");
    });
    document.getElementById("btnDoorOpen").addEventListener("click", () => {
      client.publish("kurnik/door/cmd", "OPEN");
    });
    document.getElementById("btnDoorClose").addEventListener("click", () => {
      client.publish("kurnik/door/cmd", "CLOSE");
    });
    document.getElementById("btnDoorStop").addEventListener("click", () => {
      client.publish("kurnik/door/cmd", "STOP");
    });
  </script>
</body>
</html>
